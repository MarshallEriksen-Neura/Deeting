# CLI 配置脚本安全性审查

## 审查日期
2024-12-16

## 审查范围
`backend/app/api/v1/cli_config.py` 中生成的 CLI 配置脚本

## 安全性检查清单

### ✅ 通过的安全检查

1. **文件系统操作范围限制**
   - ✅ 只操作用户主目录下的特定子目录
   - ✅ Claude CLI: `~/.claude/` (用户级配置)
   - ✅ Codex CLI: `~/.codex/` (用户级配置)
   - ✅ 不会触碰系统目录 (`/etc`, `/usr`, `/bin` 等)
   - ✅ 不会触碰其他用户文件

2. **错误处理**
   - ✅ Bash 脚本使用 `set -e`，遇到错误立即停止
   - ✅ PowerShell 脚本使用 try-catch 处理 JSON 解析错误
   - ✅ 有明确的错误提示信息

3. **文件权限**
   - ✅ Unix 系统使用 `chmod 600` 保护配置文件
   - ✅ 确保 API Key 只有所有者可读写
   - ✅ Windows 系统文件默认在用户目录下，受 NTFS 权限保护

4. **配置合并策略**
   - ✅ 优先使用 `jq` 或 `python3` 合并现有配置
   - ✅ 只更新特定字段 (env.ANTHROPIC_AUTH_TOKEN, env.ANTHROPIC_BASE_URL)
   - ✅ 保留用户的其他配置 (主题、快捷键、MCP 服务器等)
   - ✅ 有明确的警告信息提示可能覆盖配置

5. **只创建不删除**
   - ✅ `mkdir -p` 只创建目录，不删除任何文件
   - ✅ `New-Item -ItemType Directory` 只创建目录
   - ✅ 没有使用 `rm`, `del`, `Remove-Item` 等删除命令
   - ✅ 没有使用通配符操作 (`rm -rf *` 等危险操作)

6. **输入验证**
   - ✅ API Key 长度验证 (>= 10 字符)
   - ✅ client 参数限制为 "claude" 或 "codex"
   - ✅ platform 参数限制为 "windows", "mac", "linux"
   - ✅ 使用 FastAPI 的 Literal 类型确保参数安全

7. **路径处理**
   - ✅ 使用环境变量 `$HOME` / `$env:USERPROFILE`
   - ✅ Python 脚本使用 `os.path.expanduser()` 正确展开路径
   - ✅ 不使用用户输入拼接路径（防止路径遍历攻击）

8. **命令注入防护**
   - ✅ API Key 和 URL 通过 f-string 插入，不通过 shell 命令
   - ✅ 使用 heredoc (`<< 'EOF'`) 避免变量展开
   - ✅ 不使用 `eval` 或动态命令执行

## 潜在风险与缓解措施

### 低风险：配置文件覆盖

**风险描述**：
如果用户系统没有 `jq` 或 `python3`，脚本会创建新配置文件，可能覆盖现有配置。

**缓解措施**：
- ✅ 有明确的警告信息
- ✅ 只覆盖 `.claude/settings.json` 或 `.codex/auth.json`，不影响其他文件
- ✅ 用户可以从备份恢复（建议在文档中提示用户备份）

### 低风险：API Key 明文存储

**风险描述**：
API Key 以明文形式存储在配置文件中。

**缓解措施**：
- ✅ 这是 Claude CLI 和 Codex CLI 的标准做法
- ✅ 文件权限设置为 600（只有所有者可读）
- ✅ 配置文件在用户主目录下，受操作系统保护
- ℹ️ 这是 CLI 工具的通用做法（类似 `~/.ssh/config`, `~/.aws/credentials`）

## 测试建议

1. **功能测试**
   - 在干净环境测试（无现有配置）
   - 在有现有配置的环境测试（验证合并逻辑）
   - 测试所有平台（Windows, macOS, Linux）

2. **安全测试**
   - 验证文件权限设置
   - 验证只操作指定目录
   - 验证错误处理（如权限不足）

3. **边界测试**
   - 测试特殊字符的 API Key
   - 测试特殊字符的 URL
   - 测试超长输入

## 审查结论

✅ **脚本安全性评估：通过**

脚本遵循最佳实践，只操作用户主目录下的特定配置文件，不会删除或修改系统文件。所有操作都有适当的错误处理和权限控制。

## 建议改进

1. ✅ **已修复**：Python 脚本中使用 `os.path.expanduser()` 正确展开 `~` 路径
2. 📝 **文档**：在用户文档中建议备份现有配置
3. 📝 **文档**：说明配置文件的权限设置和安全性

## 审查人员
AI Assistant (Kiro)

## 复审日期
建议每次修改脚本生成逻辑后重新审查
