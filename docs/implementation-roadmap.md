# 计费与配额系统完整实施路线图

## 📋 文档索引

### 已完成的设计文档

1. **clean-slate-optimal-solution.md** - 从零开始的最优方案（Part 1）
   - 设计目标与核心原则
   - 架构设计与数据流向
   - 数据库 Schema 设计
   - Redis 数据结构设计
   - Redis Lua 脚本
   - QuotaCheckStep 实现

2. **clean-slate-optimal-solution-part2.md** - 代码实现（Part 2）
   - BillingStep 实现
   - BillingRepository 实现
   - 流式计费回调实现

3. **clean-slate-optimal-solution-part3.md** - 配置与测试（Part 3）
   - 流式计费回调
   - StreamTokenAccumulator 增强
   - 配置文件
   - 测试用例
   - 部署与运维
   - 监控与告警

4. **clean-slate-implementation-summary.md** - 实施总结
   - 方案概述
   - 关键变更点
   - 实施步骤
   - 测试验收标准

5. **clean-slate-remaining-implementation.md** - 剩余功能实现
   - 调整流程（quota_check 扣减）
   - 周期性同步任务
   - API Key 预算
   - 事务后调度器
   - 会话分布式锁
   - 路由亲和状态机
   - 类型化 Context
   - 补充测试

---

## 🎯 实施路线图

### 阶段 1：基础架构（第 1-2 周）

#### Week 1: 数据库与 Redis

**Day 1-2**: 数据库 Schema
- [ ] 创建 tenant_quota 表
- [ ] 创建 billing_transaction 表
- [ ] 创建 api_key_quota 表
- [ ] 运行 Alembic 迁移
- [ ] 验证表结构

**Day 3-4**: Redis Lua 脚本
- [ ] 创建 quota_check.lua
- [ ] 创建 quota_deduct.lua
- [ ] 创建 apikey_budget_deduct.lua
- [ ] 实现脚本加载器
- [ ] 测试脚本功能

**Day 5**: 缓存键与监控
- [ ] 定义 CacheKeys
- [ ] 定义监控指标
- [ ] 配置 Prometheus
- [ ] 配置 Grafana Dashboard

#### Week 2: 核心步骤重构

**Day 6-7**: QuotaCheckStep
- [ ] 实现配额检查并扣减
- [ ] 实现 Redis Lua 调用
- [ ] 实现缓存预热（SETNX）
- [ ] 实现 DB 回退
- [ ] 单元测试
- [ ] 集成测试

**Day 8-9**: BillingStep
- [ ] 实现只写流水（不扣减）
- [ ] 实现费用差额调整
- [ ] 实现 API Key 预算更新
- [ ] 实现流式两阶段提交
- [ ] 单元测试
- [ ] 集成测试

**Day 10**: BillingRepository
- [ ] 实现 record_transaction()
- [ ] 实现 create_pending_transaction()
- [ ] 实现 commit_pending_transaction()
- [ ] 实现幂等性检查
- [ ] 单元测试

---

### 阶段 2：高级功能（第 3-4 周）

#### Week 3: 同步与调度

**Day 11-12**: 周期性同步任务
- [ ] 实现 quota_sync.py
- [ ] 实现 apikey_sync.py
- [ ] 配置 Celery Beat
- [ ] 实现一致性检查
- [ ] 实现告警机制
- [ ] 测试同步准确性

**Day 13-14**: 事务后调度器
- [ ] 实现 TransactionAwareCelery
- [ ] 修改 BillingStep 使用
- [ ] 修改流式计费回调
- [ ] 测试事务提交/回滚
- [ ] 测试任务发送

**Day 15**: 流式 Token 精确计算
- [ ] 增强 StreamTokenAccumulator
- [ ] 实现 tiktoken 计算
- [ ] 实现三级优先级
- [ ] 测试计算准确性

#### Week 4: 并发控制与类型安全

**Day 16-17**: 会话分布式锁
- [ ] 实现 DistributedLock
- [ ] 修改 ConversationAppendStep
- [ ] 测试并发控制
- [ ] 测试锁超时
- [ ] 测试锁释放

**Day 18-19**: 路由亲和状态机
- [ ] 实现 RoutingAffinity
- [ ] 修改 RoutingStep
- [ ] 修改 UpstreamCallStep
- [ ] 测试状态转换
- [ ] 测试成功计数

**Day 20**: 类型化 Context
- [ ] 实现 TypedContextFields
- [ ] 修改 WorkflowContext
- [ ] 更新所有步骤使用
- [ ] 测试类型安全
- [ ] 测试向后兼容

---

### 阶段 3：测试与优化（第 5 周）

#### Week 5: 全面测试

**Day 21-22**: 单元测试
- [ ] QuotaCheckStep 测试（10+ 用例）
- [ ] BillingStep 测试（10+ 用例）
- [ ] BillingRepository 测试（10+ 用例）
- [ ] 同步任务测试（5+ 用例）
- [ ] 分布式锁测试（5+ 用例）
- [ ] 路由亲和测试（5+ 用例）

**Day 23-24**: 集成测试
- [ ] 非流式端到端测试
- [ ] 流式端到端测试
- [ ] 并发测试（100+ 并发）
- [ ] 故障恢复测试
- [ ] 一致性测试

**Day 25**: 性能测试与优化
- [ ] 压力测试（1000 QPS）
- [ ] 延迟测试（P99 < 100ms）
- [ ] Redis 性能测试
- [ ] DB 性能测试
- [ ] 性能优化

---

## 📊 关键指标

### 功能完整性

- [ ] 15 个一致性问题全部修复
- [ ] 8 个剩余功能全部实现
- [ ] 100% 测试覆盖率
- [ ] 0 个已知 Bug

### 性能指标

- [ ] quota_check P99 < 50ms
- [ ] billing P99 < 100ms
- [ ] 端到端 P99 < 500ms
- [ ] 支持 1000 QPS

### 可靠性指标

- [ ] 配额一致性 > 99.99%
- [ ] 幂等性 100%
- [ ] 事务成功率 > 99.9%
- [ ] 同步延迟 < 5 分钟

---

## 🚀 部署计划

### 预发布环境（第 6 周）

**Day 26-27**: 预发布部署
- [ ] 部署到预发布环境
- [ ] 运行完整测试套件
- [ ] 监控指标验证
- [ ] 性能基准测试
- [ ] 修复发现的问题

**Day 28**: 灰度发布准备
- [ ] 准备灰度发布方案
- [ ] 准备回滚方案
- [ ] 准备监控告警
- [ ] 准备应急预案

### 生产环境（第 7 周）

**Day 29**: 灰度发布（10% 流量）
- [ ] 部署到生产环境
- [ ] 开启 10% 流量
- [ ] 监控关键指标
- [ ] 验证功能正确性
- [ ] 验证性能指标

**Day 30**: 全量发布（100% 流量）
- [ ] 逐步增加流量（10% -> 50% -> 100%）
- [ ] 持续监控指标
- [ ] 验证一致性
- [ ] 验证性能
- [ ] 发布完成

---

## ✅ 验收清单

### 功能验收

#### 配额管理
- [ ] quota_check 原子扣减配额
- [ ] billing 只写流水
- [ ] 并发请求无重复扣减
- [ ] 费用差额正确调整
- [ ] API Key 预算正确更新

#### 同步机制
- [ ] 每 5 分钟同步配额
- [ ] 每 10 分钟同步 API Key 预算
- [ ] 每 1 小时检查一致性
- [ ] 差异超过阈值时告警
- [ ] Redis 与 DB 最终一致

#### 事务安全
- [ ] 任务在事务提交后发送
- [ ] 事务回滚时任务不发送
- [ ] 支持批量任务发送
- [ ] 幂等性保证

#### 并发控制
- [ ] 会话锁防止并发写入
- [ ] 锁超时自动释放
- [ ] 路由亲和状态正确
- [ ] 只在成功时更新亲和

#### 类型安全
- [ ] 类型化 Context 提供类型提示
- [ ] 向后兼容原有方法
- [ ] 防止键名冲突

### 性能验收

- [ ] quota_check P99 < 50ms
- [ ] billing P99 < 100ms
- [ ] 端到端 P99 < 500ms
- [ ] 支持 1000 QPS
- [ ] 分布式锁获取 < 10ms
- [ ] 同步任务执行 < 5 分钟

### 可靠性验收

- [ ] 配额一致性 > 99.99%
- [ ] 幂等性 100%
- [ ] 事务成功率 > 99.9%
- [ ] 同步延迟 < 5 分钟
- [ ] Redis 故障自动降级
- [ ] DB 故障自动降级

### 监控验收

- [ ] 所有关键操作有日志
- [ ] 所有关键指标有监控
- [ ] 异常情况有告警
- [ ] Grafana Dashboard 完整
- [ ] AlertManager 规则完整

---

## 📝 风险与应对

### 风险 1：Redis 性能瓶颈

**风险描述**：高并发下 Redis Lua 脚本可能成为瓶颈

**应对措施**：
- 使用 Redis Cluster 分片
- 优化 Lua 脚本性能
- 增加 Redis 连接池
- 实现 DB 降级方案

### 风险 2：同步延迟过大

**风险描述**：周期性同步可能导致 Redis 与 DB 差异过大

**应对措施**：
- 缩短同步周期（5 分钟 -> 1 分钟）
- 实现实时同步（事务后钩子）
- 增加一致性检查频率
- 差异超过阈值时立即同步

### 风险 3：分布式锁死锁

**风险描述**：分布式锁可能导致死锁或性能下降

**应对措施**：
- 设置合理的锁超时时间
- 实现锁自动续期
- 监控锁等待时间
- 提供手动释放锁的工具

### 风险 4：类型化 Context 兼容性

**风险描述**：类型化 Context 可能与现有代码不兼容

**应对措施**：
- 保留原有 get/set 方法
- 渐进式迁移
- 充分测试向后兼容性
- 提供迁移指南

---

## 🎉 总结

本路线图涵盖了计费与配额系统的完整实施过程：

- **5 个设计文档**：完整的设计方案和代码实现
- **7 周实施计划**：从基础架构到生产部署
- **23 个功能点**：全面覆盖所有需求
- **100+ 测试用例**：确保质量和可靠性
- **完整的监控告警**：保障系统稳定运行

预计总工作量：**7 周**（35 个工作日）

所有功能都已经有详细的设计和实现代码，可以直接开始实施！
