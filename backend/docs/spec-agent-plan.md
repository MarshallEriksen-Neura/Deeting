# Spec Agent æ ¸å¿ƒè®¾è®¡ç™½çš®ä¹¦ (v2.0)

> **ç‰ˆæœ¬æ³¨è®°**: æœ¬æ–‡æ¡£å‡çº§äº†åŸæœ‰çš„ Spec Agent è®¡åˆ’ï¼Œå¼•å…¥äº† "åŒ…å·¥å¤´-å°å·¥" (Foreman-Worker) æ¶æ„ã€DAG æ‹“æ‰‘æ‰§è¡Œæµä»¥åŠåŸºäºé€»è¾‘ç½‘å…³ (Logic Gate) çš„åŠ¨æ€å†³ç­–æœºåˆ¶ã€‚

## 1. æ ¸å¿ƒå“²å­¦ (Core Philosophy)

### 1.1 å†³ç­–ä¸æ‰§è¡Œçš„å½»åº•è§£è€¦
æˆ‘ä»¬ä¸å†è¯•å›¾è®©ä¸€ä¸ªæ¨¡å‹åšå®Œæ‰€æœ‰äº‹æƒ…ã€‚
- **åŒ…å·¥å¤´ (Master LLM / Foreman)**:
    -   **èŒè´£**: è´Ÿè´£é«˜å±‚çš„æ„å›¾å¯¹é½ã€æ‹“æ‰‘å›¾ (DAG) ç”Ÿæˆã€å¼‚å¸¸æ—¶çš„é‡è§„åˆ’ (Re-plan)ã€‚
    -   **ç‰¹ç‚¹**: æ™ºå•†é«˜ï¼Œæˆæœ¬é«˜ï¼Œä¸ç›´æ¥å¹²è„æ´»ã€‚
- **å°å·¥ (Worker Models / Plugins)**:
    -   **èŒè´£**: é€šè¿‡ MCP åè®®è°ƒç”¨çš„å»ä¸­å¿ƒåŒ–èŠ‚ç‚¹ã€‚å„å¸å…¶èŒ (æœç´¢ã€è®¡ç®—ã€ä»£ç æ‰§è¡Œ)ã€‚
    -   **ç‰¹ç‚¹**: ä¸“ç²¾å•ä¸€ä»»åŠ¡ï¼Œä¸æ„ŸçŸ¥å…¨å±€ï¼Œæˆæœ¬ä½ã€‚

### 1.2 "Spec-Mode" (è§„æ ¼æ¨¡å¼)
ç³»ç»Ÿä» "å¯¹è¯æµ" å‡çº§ä¸º "æ–½å·¥æµ"ã€‚
- **Drafting (æ‹Ÿæ€)**: ç”¨æˆ·è¡¨è¾¾æ„å›¾ -> Foreman ç”Ÿæˆç»“æ„åŒ–è“å›¾ (Spec DAG)ã€‚
- **Review (å®¡æ‰¹)**: ç”¨æˆ·åœ¨ "å¯è§†åŒ–ç”»å¸ƒ" (Canvas UI) ä¸ŠæŸ¥çœ‹æ–½å·¥è·¯å¾„ï¼Œå¹¶åœ¨å…³é”®èŠ‚ç‚¹è¿›è¡Œå®¡æ‰¹ã€‚
- **Runtime (æ‰§è¡Œ)**: ç³»ç»Ÿè°ƒåº¦å†…æ ¸æ ¹æ® DAG ä¾èµ–å…³ç³»ï¼Œå¹¶å‘æˆ–ä¸²è¡Œè°ƒåº¦ Worker æ‰§è¡Œã€‚

---

## 2. åè®®è§„èŒƒï¼šå£°æ˜å¼ Spec (v1.2)

### 2.1 æ ¸å¿ƒç»“æ„
ä¸å†æ˜¯ç®€å•çš„æ­¥éª¤åˆ—è¡¨ï¼Œè€Œæ˜¯åŸºäº `needs` ä¾èµ–çš„æœ‰å‘æ— ç¯å›¾ (DAG)ï¼Œæ”¯æŒå¤æ‚çš„é€»è¾‘åˆ†æ”¯ã€‚

```json
{
  "spec_v": "1.2",
  "project_name": "Laptop_Purchase_Strategy_2026",
  "nodes": [
    {
      "id": "T1_Inquiry",
      "type": "action",
      "worker": "mcp.search.jd_stock",
      "args": { "keyword": "æœºæ¢°é©å‘½ è€€ä¸– 32Gç‰ˆ", "max_price": 10000 },
      "output_as": "stock_status",
      "needs": []
    },
    {
      "id": "G1_Stock_Check",
      "type": "logic_gate",
      "input": "{{stock_status}}",
      "rules": [
        {
          "condition": "$.has_32G_stock == true",
          "next_node": "T2_Final_Verify",
          "desc": "åº“å­˜å……è¶³ï¼Œè¿›å…¥ç»ˆå®¡"
        },
        {
          "condition": "$.has_32G_stock == false",
          "next_node": "T3_Calculate_Upgrade_Cost",
          "desc": "ç¼ºè´§ï¼Œå¯åŠ¨ Plan B (16G+è‡ªè£…)"
        }
      ],
      "default": "T4_Switch_Brand" 
    },
    {
      "id": "T3_Calculate_Upgrade_Cost",
      "type": "action",
      "worker": "mcp.calculator.evaluate",
      "args": {
        "base_laptop": "{{stock_status.16G_price}}",
        "ram_32G_module": "mcp.search.market_price('Crucial DDR5 5600 32G')"
      },
      "needs": ["G1_Stock_Check"],
      "check_in": true  // ç­–ç•¥ç†”æ–­ç‚¹ï¼šéœ€ç”¨æˆ·å®¡æ‰¹
    }
  ]
}
```

### 2.2 å…³é”®æ¦‚å¿µ
*   **DAG (ä¾èµ–å›¾)**: é€šè¿‡ `needs` å­—æ®µå®šä¹‰ä¾èµ–ï¼Œæ‰§è¡Œå™¨è‡ªåŠ¨åˆ¤æ–­å¹¶è¡Œ (Parallel) æˆ–ä¸²è¡Œ (Sequential)ã€‚
*   **Logic Gate (é€»è¾‘ç½‘å…³)**: æ”¯æŒ `switch-case` å’Œ `condition` åˆ†æ”¯ï¼Œå…è®¸ Agent æ ¹æ®æ‰§è¡Œä¸­é—´ç»“æœè‡ªåŠ¨åˆ‡æ¢è·¯å¾„ã€‚
*   **Data Contract (æ•°æ®å¥‘çº¦)**: æ˜ç¡®æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å…¥è¾“å‡º Schema (`output_as`)ï¼Œç¡®ä¿è·¨æ¨¡å‹æ•°æ®æµåŠ¨å®‰å…¨ã€‚
*   **Check-in (ç­–ç•¥ç†”æ–­)**: åœ¨ `spec` ä¸­æ ‡è®° `check_in: true`ï¼Œæ‰§è¡Œå™¨è¿è¡Œåˆ°æ­¤èŠ‚ç‚¹å‰å¿…é¡»æš‚åœå¹¶ç­‰å¾…ç”¨æˆ·ä¿¡å· (Approve/Reject)ã€‚

---

## 3. äº¤äº’æ ‡å‡†ï¼šå¯è§†åŒ–ä¸å®¡æ‰¹

### 3.1 å¯è§†åŒ–é“¾è·¯ (Canvas UI)
ç”¨æˆ·ç•Œé¢ä¸å†æ˜¯å•ä¸€çš„ Chat Bubbleï¼Œè€Œæ˜¯ä¸€ä¸ªåŠ¨æ€çš„ "æ–½å·¥ç°åœº"ã€‚
- **èŠ‚ç‚¹çŠ¶æ€åŒ–**: ç”¨é¢œè‰²æ ‡è¯†èŠ‚ç‚¹çŠ¶æ€ (ğŸŸ¢ æˆåŠŸ, ğŸ”µ æ‰§è¡Œä¸­, âšª å¾…è§¦å‘, ğŸ”´ å¤±è´¥/è·³è¿‡)ã€‚
- **è·¯å¾„é«˜äº®**: å½“ Logic Gate åšå‡ºé€‰æ‹©æ—¶ï¼ŒUI å®æ—¶ç‚¹äº®æ¿€æ´»çš„åˆ†æ”¯ï¼Œç½®ç°åºŸå¼ƒçš„åˆ†æ”¯ã€‚

### 3.2 ç­–ç•¥ç†”æ–­æœºåˆ¶ (Check-in)
åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼Œç³»ç»Ÿå¼ºåˆ¶è§¦å‘ "Human-in-the-loop"ï¼š
1.  **è·¯å¾„åˆ‡æ¢ (Branch Switch)**: åŸå®šè®¡åˆ’èµ°ä¸é€šï¼ŒAgent å»ºè®®åˆ‡æ¢åˆ° Plan Bã€‚
2.  **æˆæœ¬è¶…æ”¯ (Budget Overflow)**: è‡ªåŠ¨è®¡ç®—çš„æ€»ä»·è¶…è¿‡é¢„è®¾é˜ˆå€¼ã€‚
3.  **é«˜é£é™©åŠ¨ä½œ (High-Risk Action)**: æ¶‰åŠæœ¬åœ°æ–‡ä»¶å†™å…¥ã€æ”¯ä»˜ã€æˆ–æ‰§è¡Œä¸å¯é€†è„šæœ¬ã€‚

---

## 4. å…¸å‹åœºæ™¯ï¼šç¬”è®°æœ¬é€‰è´­ (End-to-End)

**åœºæ™¯**: ç”¨æˆ·è¾“å…¥ "1ä¸‡ä»¥å†…ï¼Œ32G+1Tï¼Œèƒ½ç¼–ç¨‹è·‘æ¨¡å‹"ã€‚

1.  **Foreman (Drafting)**: 
    -   ç”ŸæˆåŒ…å« "äº¬ä¸œæœæœºå‹"ã€"Bç«™çœ‹æ•£çƒ­"ã€"å®˜ç½‘æŸ¥æ‰‹å†Œ" çš„å¹¶å‘ Specã€‚
    -   é¢„åŸ‹ "å¦‚æœ 32G æ²¡è´§ï¼Œåˆ™è®¡ç®— 16G+è‡ªè£…æˆæœ¬" çš„é€»è¾‘ç½‘å…³ã€‚

2.  **Workers (Execution - Stage 1)**: 
    -   Worker A (Search) å¹¶å‘æŠ“å–ä¿¡æ¯ï¼Œå‘ç°æœºæ¢°é©å‘½ 32G ç‰ˆç¼ºè´§ã€‚
    -   Worker B (Hardware) ç¡®è®¤è¯¥æœºå‹æ”¯æŒåŒæ’æ§½æ‰©å±•ã€‚

3.  **Gateway (Logic Routing)**:
    -   `G1_Stock_Check` èŠ‚ç‚¹è¯»å– Worker A ç»“æœï¼Œå‘½ä¸­ "ç¼ºè´§" è§„åˆ™ã€‚
    -   è‡ªåŠ¨æ¿€æ´» `T3_Calculate_Upgrade_Cost` åˆ†æ”¯ã€‚

4.  **Check-in (Approval)**:
    -   UI å¼¹å‡ºæç¤ºï¼š"32G ç‰ˆç¼ºè´§ã€‚Plan B (ä¹° 16G è‡ªè£…) æ€»æˆæœ¬ 8200 å…ƒï¼Œæ¯”åŸä»·çœ 500 å…ƒã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ"
    -   ç”¨æˆ·ç‚¹å‡» **[åŒæ„]**ã€‚

5.  **Workers (Execution - Stage 2)**:
    -   æ‰§è¡Œå™¨è§£é”åç»­èŠ‚ç‚¹ï¼Œç”ŸæˆåŒ…å«è´­ä¹°é“¾æ¥å’Œæ‹†æœºæ•™ç¨‹çš„æœ€ç»ˆæŠ¥å‘Šã€‚

---

## 5. æ¶æ„ç»„ä»¶ (Technical Architecture)

### 5.1 Dual Kernel (åŒæ ¸æ¶æ„)
-   **Data Kernel (Python/Gateway)**: 
    -   **Orchestrator**: è§£æ Spec JSONï¼Œç»´æŠ¤ DAG çŠ¶æ€æœºã€‚
    -   **Dispatcher**: å°† Task åˆ†å‘ç»™å¯¹åº”çš„ MCP æ’ä»¶æˆ– Worker æ¨¡å‹ã€‚
-   **Render Kernel (Frontend/Deeting)**:
    -   **Canvas Renderer**: åŸºäº React Flow æˆ–ç±»ä¼¼åº“ç»˜åˆ¶åŠ¨æ€ DAGã€‚
    -   **Interaction Handler**: å¤„ç†ç”¨æˆ·çš„ Approve/Reject/Modify åŠ¨ä½œå¹¶å›ä¼ ç»™ Orchestratorã€‚

### 5.2 æ’ä»¶åˆ†å‘ (Plugin Ecosystem)
-   ä¿æŒåŸæœ‰è®¾è®¡ï¼Œé‡‡ç”¨ Git-based Registry å’Œ CDN åˆ†å‘ã€‚
-   æ’ä»¶å…ƒæ•°æ® (`llm-tool.yaml`) éœ€å¢å¼ºï¼Œå£°æ˜å…¶ Input/Output Schema ä»¥æ”¯æŒ Data Contract æ ¡éªŒã€‚